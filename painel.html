<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painel Smash do Cabo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root{ --brand:#ff6600; --dark:#111827; --muted:#6b7280;
           --row-green:#e7f7ec; --row-yellow:#fff7d6; --row-red:#fde2e1; }
    body{ background:#f6f7fb; min-height:100vh; display:flex; }
    .sidebar{ width:240px; background:var(--dark); color:#fff; padding:24px 16px; }
    .sidebar a{ color:#fff; text-decoration:none; display:block; padding:8px 10px; border-radius:8px; font-weight:600; }
    .sidebar a:hover{ background:#374151; }
    .main{ flex:1; padding:24px; }
    .card-kpi{ border:1px solid #eef0f4; border-radius:16px; padding:18px; box-shadow:0 8px 16px rgba(0,0,0,.06); }
    .card-kpi h6{ margin:0; color:#111; font-weight:700; }
    .card-kpi .val{ font-size:28px; font-weight:800; }
    .header{ background:var(--brand); color:#fff; padding:14px 20px; border-radius:12px; margin-bottom:16px; }
    #login-box{ max-width:420px; margin:80px auto; padding:28px; background:#fff; border-radius:16px; box-shadow:0 12px 24px rgba(0,0,0,.12); }
    .btn-whatsapp{ background:#25D366; color:#fff; }
    .btn-delete{ background:#dc3545; color:#fff; }
    .table thead th{ background:#f1f3f7; }
    .row-green{ background:var(--row-green)!important; }
    .row-yellow{ background:var(--row-yellow)!important; }
    .row-red{ background:var(--row-red)!important; }
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div id="login-box">
    <h3 class="mb-3">Painel Smash do Cabo</h3>
    <input type="text" id="username" class="form-control mb-2" placeholder="Usuário">
    <input type="password" id="password" class="form-control mb-3" placeholder="Senha">
    <button class="btn btn-dark w-100" onclick="verificarLogin()">Entrar</button>
    <div class="text-muted small mt-3">Dica: em breve migrar login para Supabase Auth + RLS.</div>
  </div>

  <!-- APP -->
  <aside class="sidebar d-none" id="menuLateral">
    <div class="mb-3 fw-bold">Painel</div>
    <a href="#" onclick="mostrar('dashboard')">Início</a>
    <a href="#" onclick="mostrar('respostas')">Respostas</a>
    <div class="mt-auto">
      <button class="btn btn-outline-light w-100 mt-4" onclick="sair()">Sair</button>
    </div>
  </aside>

  <main class="main d-none" id="app">
    <!-- DASHBOARD -->
    <section id="dashboard" class="d-none">
      <div class="header"><h4 class="m-0">Painel Smash do Cabo</h4></div>

      <!-- FILTRO DE TEMPO -->
      <div class="bg-white p-3 rounded-3 shadow-sm mb-3">
        <div class="row g-2 align-items-end">
          <div class="col-12 col-md-3">
            <label class="form-label">Período</label>
            <select id="presetPeriodo" class="form-select" onchange="onPresetChange()">
              <option value="hoje">Hoje</option>
              <option value="semana">Esta semana</option>
              <option value="mes">Este mês</option>
              <option value="custom">Personalizado</option>
            </select>
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">De</label>
            <input type="date" id="dataDe" class="form-control">
          </div>
          <div class="col-6 col-md-3">
            <label class="form-label">Até</label>
            <input type="date" id="dataAte" class="form-control">
          </div>
          <div class="col-12 col-md-3 d-grid">
            <button class="btn btn-primary" onclick="aplicarFiltro()">Aplicar</button>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <div class="row g-3 mb-3">
        <div class="col-12 col-sm-6 col-lg"><div class="card-kpi"><h6>NPS</h6><div class="val" id="kpi-nps">–</div></div></div>
        <div class="col-6 col-lg"><div class="card-kpi"><h6>Promotores</h6><div class="val" id="kpi-prom">–</div></div></div>
        <div class="col-6 col-lg"><div class="card-kpi"><h6>Neutros</h6><div class="val" id="kpi-neu">–</div></div></div>
        <div class="col-6 col-lg"><div class="card-kpi"><h6>Detratores</h6><div class="val" id="kpi-det">–</div></div></div>
        <div class="col-6 col-lg"><div class="card-kpi"><h6>Respostas</h6><div class="val" id="kpi-total">–</div></div></div>
      </div>

      <div class="d-flex align-items-center justify-content-between mb-2">
        <h5 class="m-0">Respostas</h5>
        <div class="input-group" style="max-width:320px;">
          <span class="input-group-text">Buscar</span>
          <input id="busca" class="form-control" placeholder="nome / telefone / email" oninput="filtrarLocal()">
        </div>
      </div>

      <div class="table-responsive bg-white rounded-3 p-2 shadow-sm">
        <table class="table table-sm table-striped align-middle" id="tbl">
          <thead>
            <tr>
              <th>Data</th>
              <th>Nome</th>
              <th>Sugestão</th>
              <th>Morador</th>
              <th>Qualidade</th>
              <th>Tempo</th>
              <th>Variedade</th>
              <th>Custo-benefício</th>
              <th>NPS</th>
              <th class="text-center">Ações</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- RESPOSTAS -->
    <section id="respostas" class="d-none">
      <div class="header"><h4 class="m-0">Respostas — Lista</h4></div>
      <p>Use a aba “Início” para ver KPIs + filtros e tabela.</p>
    </section>
  </main>

<script>
  // --------- CONFIG ---------
  const SUPABASE_URL = 'https://kwktdbinfadztnkghuul.supabase.co';
  // mesma key e tabela que você usa no form de pesquisa (feedback_detalhado):contentReference[oaicite:4]{index=4}
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt3a3RkYmluZmFkenRua2dodXVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDc5NzI5NjAsImV4cCI6MjA2MzU0ODk2MH0.jN-ggFrIE1x_4kO8KE5G_bZq6V1yFT1El64oQ_ELubY';

  // --------- LOGIN (simples) ---------
  function verificarLogin(){
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value.trim();
    if(u==='admin' && p==='1234'){ // mesmo comportamento do seu painel atual:contentReference[oaicite:5]{index=5}
      document.getElementById('login-box').classList.add('d-none');
      document.getElementById('menuLateral').classList.remove('d-none');
      document.getElementById('app').classList.remove('d-none');
      mostrar('dashboard');
      setPresetDefault();
      aplicarFiltro();
    } else {
      alert('Usuário ou senha incorretos');
    }
  }
  function sair(){ location.reload(); }

  function mostrar(id){
    document.querySelectorAll('main section').forEach(s => s.classList.add('d-none'));
    document.getElementById(id).classList.remove('d-none');
  }

  // --------- FILTRO DE TEMPO ---------
  function setPresetDefault(){
    const today = new Date();
    document.getElementById('presetPeriodo').value = 'mes';
    setPeriodo('mes', today);
  }
  function onPresetChange(){
    const v = document.getElementById('presetPeriodo').value;
    setPeriodo(v, new Date());
  }
  function setPeriodo(preset, refDate){
    const de = document.getElementById('dataDe');
    const ate = document.getElementById('dataAte');
    const d = new Date(refDate);
    const a = new Date(refDate);
    if(preset==='hoje'){
      // de = hoje 00:00, ate = hoje 23:59
    } else if(preset==='semana'){
      const day = d.getDay(); // 0 dom
      const diff = (day+6)%7; // segunda-feira
      d.setDate(d.getDate()-diff);
      a.setDate(d.getDate()+6);
    } else if(preset==='mes'){
      d.setDate(1);
      a.setMonth(a.getMonth()+1, 0);
    } else if(preset==='custom'){
      de.disabled = false; ate.disabled = false;
      return;
    }
    de.disabled = false; ate.disabled = false;
    de.value = toISODate(d);
    ate.value = toISODate(a);
  }
  function toISODate(dt){ return dt.toISOString().split('T')[0]; }

  async function aplicarFiltro(){
    const de = document.getElementById('dataDe').value;
    const ate = document.getElementById('dataAte').value;
    await carregarRespostas({de, ate});
  }

  // --------- CARREGAR / CALCULAR ---------
  let dadosBrutos = [];
  async function carregarRespostas({de, ate}={}){
    // monta query com created_at gte/lte
    let url = `${SUPABASE_URL}/rest/v1/feedback_detalhado?select=*`;
    const params = [];
    if(de) params.push(`created_at=gte.${de}`);
    if(ate) params.push(`created_at=lte.${ate}T23:59:59`);
    if(params.length) url += '&' + params.join('&');

    const resp = await fetch(url, {
      headers: { apikey: SUPABASE_KEY, Authorization: `Bearer ${SUPABASE_KEY}` }
    });
    dadosBrutos = await resp.json();
    // ordena desc
    dadosBrutos.sort((a,b)=> new Date(b.created_at||0) - new Date(a.created_at||0));

    renderTabela(dadosBrutos);
    renderKPIs(dadosBrutos);
  }

  function mediaEstrelas(r){
    const arr = [r.atendimento, r.qualidade, r.tempo, r.variedade, r.custobeneficio]
      .map(x => typeof x==='number' ? x : Number(x))
      .filter(x => !isNaN(x) && x>0);
    if(!arr.length) return null;
    return arr.reduce((s,v)=>s+v,0)/arr.length;
  }

  function classePorMedia(m){
    if(m==null) return '';
    if(m >= 4) return 'row-green';
    if(Math.round(m) === 3) return 'row-yellow';
    if(m <= 2) return 'row-red';
    return '';
  }

  function renderTabela(lista){
    const tbody = document.querySelector('#tbl tbody');
    tbody.innerHTML = '';
    const termo = (document.getElementById('busca').value||'').toLowerCase();

    lista.forEach(r => {
      if(termo && !`${r.nome||''} ${r.telefone||''} ${r.email||''}`.toLowerCase().includes(termo)) return;

      const dt = r.created_at ? new Date(r.created_at).toLocaleDateString('pt-BR') : '–';
      const nps = r.indicacao ?? '';
      const med = mediaEstrelas(r);
      const cls = classePorMedia(med);

      const telNum = (r.telefone||'').replace(/[^0-9]/g,'');
      const tr = document.createElement('tr');
      if(cls) tr.classList.add(cls);
      tr.innerHTML = `
        <td>${dt}</td>
        <td>${r.nome||''}</td>
        <td>${r.sugestao||''}</td>
        <td>${r.morador||''}</td>
        <td>${r.qualidade ?? ''}</td>
        <td>${r.tempo ?? ''}</td>
        <td>${r.variedade ?? ''}</td>
        <td>${r.custobeneficio ?? ''}</td>
        <td>${nps}</td>
        <td class="text-center">
          <a href="https://wa.me/55${telNum}" target="_blank" class="btn btn-sm btn-whatsapp">WhatsApp</a>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  function filtrarLocal(){ renderTabela(dadosBrutos); }

  function renderKPIs(lista){
    // NPS a partir de 'indicacao' (0–10) — o formulário salva como 'indicacao':contentReference[oaicite:6]{index=6}
    const npsVals = lista.map(x => Number(x.indicacao)).filter(x => !isNaN(x));
    const total = npsVals.length;
    const prom = npsVals.filter(x => x>=9).length;
    const neu  = npsVals.filter(x => x>=7 && x<=8).length;
    const det  = npsVals.filter(x => x<=6).length;
    const nps  = total ? Math.round(((prom - det) / total) * 100) : 0;

    document.getElementById('kpi-nps').textContent = nps;
    document.getElementById('kpi-prom').textContent = prom;
    document.getElementById('kpi-neu').textContent  = neu;
    document.getElementById('kpi-det').textContent  = det;
    document.getElementById('kpi-total').textContent= total;
  }
</script>
</body>
</html>
