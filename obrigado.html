<script>
document.addEventListener('DOMContentLoaded', async () => {
  if (!localStorage.getItem('cliente_telefone')) {
    window.location.href = 'index.html';
    return;
  }

  // ✅ CONFIGURAÇÃO CORRETA SUPABASE
  const SUPABASE_URL = 'https://leezpmpmqkiocvvpcwqa.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxlZXpwbXBtcWtpb2N2dnBjd3FhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE5NTI2NTUsImV4cCI6MjA4NzUyODY1NX0.M-TpjLCmwA6jyUFXG33o-L8O_1o84Ap4GM9vtxAa4KQ';
  const BRINDE = '1 Soda Italiana';

  const nome     = localStorage.getItem('cliente_nome') || 'Cliente';
  const telefone = (localStorage.getItem('cliente_telefone') || '').trim();
  const hojeISO  = new Date().toISOString().split('T')[0];

  const headers = {
    apikey: SUPABASE_ANON_KEY,
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    'Content-Type': 'application/json'
  };

  function gerarCodigoAleatorio() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let code = '';
    for (let i = 0; i < 4; i++) {
      code += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return 'SMASH-' + code;
  }

  async function buscarCupomValido() {
    const url = `${SUPABASE_URL}/rest/v1/cupons?cliente_telefone=eq.${encodeURIComponent(telefone)}&utilizado=eq.false&valido_ate=gte.${hojeISO}`;
    const r = await fetch(url, { headers });
    return r.json();
  }

  async function criarCupom(codigo, validoAteISO, linkVerif) {
    const resp = await fetch(`${SUPABASE_URL}/rest/v1/cupons`, {
      method: 'POST',
      headers,
      body: JSON.stringify({
        codigo,
        cliente_nome: nome,
        cliente_telefone: telefone,
        brinde: BRINDE,
        valido_ate: validoAteISO,
        utilizado: false,
        link_verificacao: linkVerif
      })
    });

    if (!resp.ok) {
      const errTxt = await resp.text();
      throw new Error(`Falha ao salvar cupom: ${resp.status} ${errTxt}`);
    }
  }

  async function garantirLinkVerificacao(codigo, linkVerif) {
    await fetch(`${SUPABASE_URL}/rest/v1/cupons?codigo=eq.${encodeURIComponent(codigo)}`, {
      method: 'PATCH',
      headers,
      body: JSON.stringify({ link_verificacao: linkVerif })
    });
  }

  function montarUI(codigo, validadeISO, linkVerif) {
  const elValidade = document.getElementById('validade');
  const elCodigo = document.getElementById('codigoCupom');
  const elQr = document.getElementById('qrcode');
  const elBtn = document.getElementById('btnCopy');

  if (!elValidade || !elCodigo || !elQr || !elBtn) {
    console.error('Algum elemento do HTML não foi encontrado.');
    return;
  }

  elValidade.textContent =
    new Date(validadeISO).toLocaleDateString('pt-BR');

  elCodigo.textContent =
    `Código do Cupom: ${codigo}`;

  elQr.innerHTML = '';

  new QRCode(elQr, {
    text: linkVerif,
    width: 160,
    height: 160
  });

  elBtn.onclick = async () => {
    try {
      await navigator.clipboard.writeText(codigo);
      const old = elBtn.textContent;
      elBtn.textContent = 'Copiado ✔';
      setTimeout(() => elBtn.textContent = old, 1200);
    } catch {
      alert('Não foi possível copiar. Copie manualmente.');
    }
  };
}

    document.getElementById('btnCopy').onclick = async () => {
      try {
        await navigator.clipboard.writeText(codigo);
        const btn = document.getElementById('btnCopy');
        const old = btn.textContent;
        btn.textContent = 'Copiado ✔';
        setTimeout(() => btn.textContent = old, 1200);
      } catch {
        alert('Não foi possível copiar. Copie manualmente.');
      }
    };
  }

  try {
    const lista = await buscarCupomValido();

    if (Array.isArray(lista) && lista.length > 0) {
      const c = lista[0];
      const link = c.link_verificacao ||
        `https://verificacupom.smashdocabo.com/?codigo=${encodeURIComponent(c.codigo)}`;

      if (!c.link_verificacao) {
        try {
          await garantirLinkVerificacao(c.codigo, link);
        } catch (_) {}
      }

      montarUI(c.codigo, c.valido_ate, link);

    } else {
      const codigo = gerarCodigoAleatorio();

      const validade = new Date();
      validade.setDate(validade.getDate() + 30);
      const validoAteISO = validade.toISOString().split('T')[0];

      const linkVerif =
        `https://verificacupom.smashdocabo.com/?codigo=${encodeURIComponent(codigo)}`;

      await criarCupom(codigo, validoAteISO, linkVerif);
      montarUI(codigo, validoAteISO, linkVerif);
    }

  } catch (err) {
    console.error('Erro ao gerar cupom:', err);
    alert('Erro ao gerar seu cupom. Tente novamente.');
  }
});
</script>
